<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Strategy IS — API Test Client</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap');

:root {
  --bg: #080c10;
  --panel: #0d1318;
  --panel2: #111920;
  --border: #1a2830;
  --border2: #1f3040;
  --gold: #c8982a;
  --gold2: #e8b84b;
  --teal: #1db8a0;
  --teal2: #25d4ba;
  --red: #e05050;
  --green: #3dba7a;
  --blue: #3a8fd4;
  --text: #d4e0e8;
  --muted: #4a6070;
  --bright: #eef4f8;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Rajdhani', sans-serif;
  font-size: 15px;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Animated grid background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(29,184,160,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(29,184,160,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

.shell {
  position: relative;
  z-index: 1;
  display: grid;
  grid-template-columns: 240px 1fr 320px;
  grid-template-rows: 56px 1fr;
  height: 100vh;
  gap: 0;
}

/* ── TOP BAR ── */
.topbar {
  grid-column: 1 / -1;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 1.5rem;
  gap: 1.5rem;
}

.logo {
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--gold2);
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo-icon { color: var(--teal); font-size: 1.3rem; }

.base-url-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  max-width: 420px;
}

.base-url-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.7rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  white-space: nowrap;
}

.base-url-input {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border2);
  color: var(--teal2);
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.78rem;
  padding: 5px 10px;
  border-radius: 3px;
  outline: none;
}
.base-url-input:focus { border-color: var(--teal); }

.token-status {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.68rem;
  color: var(--muted);
}

.dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--muted);
  transition: background 0.3s;
  box-shadow: 0 0 6px transparent;
}
.dot.active {
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
}

/* ── SIDEBAR ── */
.sidebar {
  background: var(--panel);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  padding: 1rem 0;
}

.sidebar-section {
  margin-bottom: 0.25rem;
}

.sidebar-section-title {
  font-size: 0.62rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--muted);
  padding: 0.6rem 1rem 0.3rem;
}

.endpoint-btn {
  width: 100%;
  background: none;
  border: none;
  text-align: left;
  padding: 0.55rem 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background 0.15s;
  font-family: 'Rajdhani', sans-serif;
}

.endpoint-btn:hover { background: rgba(29,184,160,0.06); }
.endpoint-btn.active {
  background: rgba(29,184,160,0.12);
  border-right: 2px solid var(--teal);
}

.method-tag {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.6rem;
  font-weight: 700;
  padding: 2px 5px;
  border-radius: 2px;
  min-width: 32px;
  text-align: center;
  flex-shrink: 0;
}

.method-tag.GET    { background: rgba(58,143,212,0.2); color: var(--blue); border: 1px solid rgba(58,143,212,0.3); }
.method-tag.POST   { background: rgba(61,186,122,0.2); color: var(--green); border: 1px solid rgba(61,186,122,0.3); }

.ep-name {
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text);
  line-height: 1.2;
}

.ep-path {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.62rem;
  color: var(--muted);
  margin-top: 1px;
}

/* ── MAIN PANEL ── */
.main {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg);
}

.request-area {
  flex-shrink: 0;
  padding: 1.25rem 1.5rem 0;
}

.request-header {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 1rem;
}

.request-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--bright);
  letter-spacing: 0.05em;
}

.request-path {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.72rem;
  color: var(--teal);
  margin-top: 4px;
}

.send-btn {
  margin-left: auto;
  background: var(--teal);
  border: none;
  color: #000;
  font-family: 'Rajdhani', sans-serif;
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 8px 22px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  flex-shrink: 0;
}

.send-btn:hover { background: var(--teal2); transform: translateY(-1px); }
.send-btn:active { transform: translateY(0); }
.send-btn:disabled { background: var(--muted); cursor: not-allowed; transform: none; }

.body-editor-wrap {
  margin-bottom: 1rem;
}

.editor-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.62rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
  margin-bottom: 0.4rem;
}

.body-editor {
  width: 100%;
  background: var(--panel);
  border: 1px solid var(--border2);
  color: var(--teal2);
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.78rem;
  line-height: 1.6;
  padding: 0.75rem 1rem;
  border-radius: 4px;
  resize: vertical;
  outline: none;
  min-height: 120px;
}

.body-editor:focus { border-color: var(--teal); }

.quick-fill-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}

.qf-btn {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.65rem;
  padding: 4px 10px;
  border-radius: 3px;
  border: 1px solid var(--border2);
  background: var(--panel);
  color: var(--gold);
  cursor: pointer;
  transition: all 0.15s;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.qf-btn:hover { border-color: var(--gold); background: rgba(200,152,42,0.1); }

.divider { height: 1px; background: var(--border); margin: 0 0 0; }

/* ── RESPONSE AREA ── */
.response-area {
  flex: 1;
  overflow-y: auto;
  padding: 1rem 1.5rem 1.5rem;
}

.response-meta {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 0.75rem;
}

.status-pill {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.72rem;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 3px;
}
.status-pill.ok   { background: rgba(61,186,122,0.2); color: var(--green); border: 1px solid rgba(61,186,122,0.4); }
.status-pill.err  { background: rgba(224,80,80,0.2);  color: var(--red);   border: 1px solid rgba(224,80,80,0.4); }
.status-pill.idle { background: var(--panel); color: var(--muted); border: 1px solid var(--border); }

.response-time {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.65rem;
  color: var(--muted);
}

.response-body {
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 4px;
  padding: 1rem;
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.75rem;
  line-height: 1.7;
  white-space: pre-wrap;
  word-break: break-all;
  min-height: 80px;
  color: var(--text);
}

.json-key   { color: var(--teal2); }
.json-str   { color: var(--gold2); }
.json-num   { color: #8be9fd; }
.json-bool  { color: #ff79c6; }
.json-null  { color: var(--muted); }

/* ── RIGHT LOG PANEL ── */
.log-panel {
  background: var(--panel);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.log-header {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.log-title {
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
}

.clear-btn {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.6rem;
  color: var(--muted);
  background: none;
  border: 1px solid var(--border);
  padding: 2px 8px;
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.15s;
}
.clear-btn:hover { color: var(--red); border-color: var(--red); }

.log-list {
  flex: 1;
  overflow-y: auto;
  padding: 0.5rem 0;
}

.log-entry {
  padding: 0.5rem 1rem;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.1s;
}
.log-entry:hover { background: rgba(255,255,255,0.02); }

.log-entry-top {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 3px;
}

.log-method {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.58rem;
  font-weight: 700;
  padding: 1px 4px;
  border-radius: 2px;
}

.log-status {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.65rem;
  font-weight: 700;
  margin-left: auto;
}
.log-status.ok  { color: var(--green); }
.log-status.err { color: var(--red); }
.log-status.pending { color: var(--gold); }

.log-path {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.65rem;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.log-time {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.58rem;
  color: var(--muted);
}

/* param rows */
.param-row {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
}
.param-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.68rem;
  color: var(--muted);
  text-align: right;
}
.param-input {
  background: var(--panel);
  border: 1px solid var(--border2);
  color: var(--teal2);
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 3px;
  outline: none;
  width: 100%;
}
.param-input:focus { border-color: var(--teal); }

/* scrollbar */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* spinner */
@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  display: inline-block;
  width: 12px; height: 12px;
  border: 2px solid var(--border2);
  border-top-color: var(--teal);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  vertical-align: middle;
  margin-right: 4px;
}

/* info box */
.info-box {
  background: rgba(200,152,42,0.08);
  border: 1px solid rgba(200,152,42,0.25);
  border-radius: 4px;
  padding: 0.6rem 0.9rem;
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.68rem;
  color: var(--gold);
  line-height: 1.6;
  margin-bottom: 0.75rem;
}

.response-section-label {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.62rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
  margin: 0.75rem 0 0.4rem;
}
</style>
</head>
<body>
<div class="shell">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="logo"><span class="logo-icon">⚔</span> Strategy IS</div>
    <div class="base-url-wrap">
      <span class="base-url-label">Base URL</span>
      <input class="base-url-input" id="baseUrl" value="http://localhost:5000" />
    </div>
    <div class="token-status">
      <div class="dot" id="tokenDot"></div>
      <span id="tokenLabel">No token</span>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-section-title">Auth</div>
      <button class="endpoint-btn active" onclick="selectEndpoint('register')">
        <div><span class="method-tag POST">POST</span></div>
        <div><div class="ep-name">Register</div><div class="ep-path">/api/v1/auth/register</div></div>
      </button>
      <button class="endpoint-btn" onclick="selectEndpoint('login')">
        <div><span class="method-tag POST">POST</span></div>
        <div><div class="ep-name">Login</div><div class="ep-path">/api/v1/auth/login</div></div>
      </button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Profile</div>
      <button class="endpoint-btn" onclick="selectEndpoint('profile')">
        <div><span class="method-tag GET">GET</span></div>
        <div><div class="ep-name">My Profile</div><div class="ep-path">/api/v1/profile</div></div>
      </button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Leaderboard</div>
      <button class="endpoint-btn" onclick="selectEndpoint('leaderboard')">
        <div><span class="method-tag GET">GET</span></div>
        <div><div class="ep-name">Leaderboard</div><div class="ep-path">/api/v1/leaderboard</div></div>
      </button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Events</div>
      <button class="endpoint-btn" onclick="selectEndpoint('event')">
        <div><span class="method-tag POST">POST</span></div>
        <div><div class="ep-name">Post Event</div><div class="ep-path">/api/v1/events</div></div>
      </button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Match</div>
      <button class="endpoint-btn" onclick="selectEndpoint('match_finish')">
        <div><span class="method-tag POST">POST</span></div>
        <div><div class="ep-name">Finish Match</div><div class="ep-path">/api/v1/match/finish</div></div>
      </button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">System</div>
      <button class="endpoint-btn" onclick="selectEndpoint('health')">
        <div><span class="method-tag GET">GET</span></div>
        <div><div class="ep-name">Health Check</div><div class="ep-path">/health</div></div>
      </button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="request-area">
      <div class="request-header">
        <div>
          <div class="request-title" id="reqTitle">Register User</div>
          <div class="request-path" id="reqPath">POST /api/v1/auth/register</div>
        </div>
        <button class="send-btn" id="sendBtn" onclick="sendRequest()">▶ Send</button>
      </div>
      <div id="infoBox" class="info-box" style="display:none"></div>
      <div id="paramsArea"></div>
      <div id="bodyArea" class="body-editor-wrap">
        <div class="editor-label">Request Body (JSON)</div>
        <div class="quick-fill-row" id="quickFillRow"></div>
        <textarea class="body-editor" id="bodyEditor" rows="6"></textarea>
      </div>
    </div>

    <div class="divider"></div>

    <div class="response-area">
      <div class="response-meta">
        <div class="status-pill idle" id="statusPill">READY</div>
        <div class="response-time" id="responseTime"></div>
      </div>
      <div class="response-section-label">Response Body</div>
      <div class="response-body" id="responseBody">// Response will appear here</div>
    </div>
  </div>

  <!-- LOG PANEL -->
  <div class="log-panel">
    <div class="log-header">
      <span class="log-title">Request Log</span>
      <button class="clear-btn" onclick="clearLog()">Clear</button>
    </div>
    <div class="log-list" id="logList"></div>
  </div>

</div>

<script>
// ── State ──
let token = null;
let currentEndpoint = 'register';
let logEntries = [];

const endpoints = {
  register: {
    title: 'Register User',
    method: 'POST',
    path: '/api/v1/auth/register',
    auth: false,
    info: 'Creates a new account. All test seed users use password: <b>password123</b>',
    quickFills: [
      { label: 'New User', body: { email: 'newplayer@example.com', password: 'password123', nickname: 'NewCommander' } },
    ],
    defaultBody: { email: 'newplayer@example.com', password: 'password123', nickname: 'NewCommander' }
  },
  login: {
    title: 'Login',
    method: 'POST',
    path: '/api/v1/auth/login',
    auth: false,
    info: 'Login with any seed user. On success, the JWT is saved automatically for protected routes.',
    quickFills: [
      { label: 'alice (admin)', body: { email: 'alice@example.com', password: 'password123' } },
      { label: 'bob (mod)',     body: { email: 'bob@example.com',   password: 'password123' } },
      { label: 'carol',        body: { email: 'carol@example.com', password: 'password123' } },
      { label: 'eve (top)',     body: { email: 'eve@example.com',   password: 'password123' } },
      { label: 'banned user',  body: { email: 'banned@example.com',password: 'password123' } },
    ],
    defaultBody: { email: 'alice@example.com', password: 'password123' }
  },
  profile: {
    title: 'My Profile',
    method: 'GET',
    path: '/api/v1/profile',
    auth: true,
    info: 'Returns the profile, roles, and progress for the currently authenticated user. Login first.',
    quickFills: [],
    defaultBody: null
  },
  leaderboard: {
    title: 'Leaderboard',
    method: 'GET',
    path: '/api/v1/leaderboard',
    auth: false,
    params: [
      { key: 'boardCode', label: 'boardCode', default: 'default' },
      { key: 'season',    label: 'season',    default: '1' },
      { key: 'limit',     label: 'limit',     default: '10' },
    ],
    quickFills: [],
    defaultBody: null,
    info: 'Try boardCode: <b>default</b> or <b>pvp</b>, season: <b>1</b>'
  },
  event: {
    title: 'Post Event',
    method: 'POST',
    path: '/api/v1/events',
    auth: true,
    info: 'Sends a game event. eventId must be unique (UUID-like, min 8 chars). Login first.',
    quickFills: [
      { label: 'Match Start', body: { eventId: '', eventType: 'match_start', sessionId: null, clientTime: null, payload: { map: 'forest_raid', mode: 'pve' } } },
      { label: 'Unit Deploy', body: { eventId: '', eventType: 'unit_deploy', sessionId: null, clientTime: null, payload: { unit: 'cavalry', count: 10 } } },
    ],
    defaultBody: { eventId: 'evt-' + Math.random().toString(36).slice(2,10), eventType: 'match_start', sessionId: null, clientTime: null, payload: { map: 'forest_raid' } }
  },
  match_finish: {
    title: 'Finish Match',
    method: 'POST',
    path: '/api/v1/match/finish',
    auth: true,
    info: 'Finishes a match in "started" state that belongs to you. Match ID 9 belongs to Alice (user 1). Login as alice first.',
    quickFills: [
      { label: 'Win (match 9)', body: { matchId: 9, result: { isWin: true, score: 1500, durationSeconds: 900, powerDelta: 50 } } },
      { label: 'Loss',          body: { matchId: 9, result: { isWin: false, score: 400, durationSeconds: 600, powerDelta: -20 } } },
    ],
    defaultBody: { matchId: 9, result: { isWin: true, score: 1500, durationSeconds: 900, powerDelta: 50 } }
  },
  health: {
    title: 'Health Check',
    method: 'GET',
    path: '/health',
    auth: false,
    info: 'Checks the server is running. No auth required.',
    quickFills: [],
    defaultBody: null
  }
};

// ── UI Helpers ──
function $(id) { return document.getElementById(id); }

function updateTokenUI() {
  const dot = $('tokenDot');
  const label = $('tokenLabel');
  if (token) {
    dot.classList.add('active');
    const payload = JSON.parse(atob(token.split('.')[1]));
    label.textContent = 'Authenticated (user ' + payload.sub + ')';
  } else {
    dot.classList.remove('active');
    label.textContent = 'No token';
  }
}

function syntaxHighlight(json) {
  if (typeof json !== 'string') json = JSON.stringify(json, null, 2);
  return json
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
      let cls = 'json-num';
      if (/^"/.test(match)) {
        cls = /:$/.test(match) ? 'json-key' : 'json-str';
      } else if (/true|false/.test(match)) {
        cls = 'json-bool';
      } else if (/null/.test(match)) {
        cls = 'json-null';
      }
      return '<span class="' + cls + '">' + match + '</span>';
    });
}

function selectEndpoint(key) {
  currentEndpoint = key;
  const ep = endpoints[key];

  // sidebar active state
  document.querySelectorAll('.endpoint-btn').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');

  $('reqTitle').textContent = ep.title;
  $('reqPath').textContent = ep.method + ' ' + ep.path;

  // info box
  const infoBox = $('infoBox');
  if (ep.info) {
    infoBox.innerHTML = ep.info;
    infoBox.style.display = 'block';
  } else {
    infoBox.style.display = 'none';
  }

  // params
  const paramsArea = $('paramsArea');
  if (ep.params && ep.params.length > 0) {
    paramsArea.innerHTML = '<div class="editor-label" style="margin-bottom:0.4rem">Query Params</div>' +
      ep.params.map(p =>
        `<div class="param-row">
          <span class="param-label">${p.label}</span>
          <input class="param-input" id="param_${p.key}" value="${p.default}" />
        </div>`
      ).join('') + '<div style="height:0.5rem"></div>';
  } else {
    paramsArea.innerHTML = '';
  }

  // body
  const bodyArea = $('bodyArea');
  if (ep.defaultBody !== null) {
    bodyArea.style.display = 'block';
    $('bodyEditor').value = JSON.stringify(ep.defaultBody, null, 2);
  } else {
    bodyArea.style.display = 'none';
  }

  // quick fills
  const qfRow = $('quickFillRow');
  if (ep.quickFills && ep.quickFills.length > 0) {
    qfRow.innerHTML = ep.quickFills.map((qf, i) =>
      `<button class="qf-btn" onclick="quickFill(${i})">${qf.label}</button>`
    ).join('');
    qfRow.style.display = 'flex';
  } else {
    qfRow.style.display = 'none';
  }

  // reset response
  $('statusPill').className = 'status-pill idle';
  $('statusPill').textContent = 'READY';
  $('responseTime').textContent = '';
  $('responseBody').innerHTML = '// Response will appear here';
}

function quickFill(i) {
  const ep = endpoints[currentEndpoint];
  const qf = ep.quickFills[i];
  let body = JSON.parse(JSON.stringify(qf.body));
  // auto-generate eventId for events
  if (currentEndpoint === 'event' && body.eventId === '') {
    body.eventId = 'evt-' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
  }
  $('bodyEditor').value = JSON.stringify(body, null, 2);
}

async function sendRequest() {
  const ep = endpoints[currentEndpoint];
  const baseUrl = $('baseUrl').value.replace(/\/$/, '');
  const btn = $('sendBtn');

  // Build URL
  let url = baseUrl + ep.path;
  if (ep.params) {
    const qp = new URLSearchParams();
    ep.params.forEach(p => {
      const val = $('param_' + p.key)?.value;
      if (val) qp.set(p.key, val);
    });
    url += '?' + qp.toString();
  }

  // Build fetch options
  const opts = { method: ep.method, headers: { 'Content-Type': 'application/json' } };
  if (ep.auth && token) opts.headers['Authorization'] = 'Bearer ' + token;
  if (ep.defaultBody !== null && ep.method === 'POST') {
    try { opts.body = $('bodyEditor').value; }
    catch(e) { alert('Invalid JSON in body'); return; }
  }

  // UI
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending';
  $('statusPill').className = 'status-pill idle';
  $('statusPill').textContent = '...';
  const t0 = Date.now();

  // Log entry
  const logId = Date.now();
  addLogEntry({ id: logId, method: ep.method, path: ep.path, status: null, time: new Date() });

  try {
    const resp = await fetch(url, opts);
    const ms = Date.now() - t0;
    let data;
    try { data = await resp.json(); } catch(e) { data = await resp.text(); }

    // Extract token from login
    if (currentEndpoint === 'login' && resp.ok && data?.data?.accessToken) {
      token = data.data.accessToken;
      updateTokenUI();
    }

    const ok = resp.ok;
    $('statusPill').className = 'status-pill ' + (ok ? 'ok' : 'err');
    $('statusPill').textContent = resp.status + ' ' + resp.statusText;
    $('responseTime').textContent = ms + 'ms';
    $('responseBody').innerHTML = syntaxHighlight(data);
    updateLogEntry(logId, resp.status);

  } catch(err) {
    $('statusPill').className = 'status-pill err';
    $('statusPill').textContent = 'CORS / NETWORK ERROR';
    $('responseBody').innerHTML =
      '<span style="color:var(--red)">Could not reach ' + url + '</span>\n\n' +
      '<span style="color:var(--gold)">Likely cause: CORS is not enabled on the server.</span>\n\n' +
      'Run once to fix:\n' +
      '  pip install flask-cors\n\n' +
      'Then restart the server:\n' +
      '  python wsgi.py\n\n' +
      '<span style="color:var(--muted)">Error detail: ' + err.message + '</span>';
    updateLogEntry(logId, 0);
  }

  btn.disabled = false;
  btn.innerHTML = '▶ Send';
}

function addLogEntry({ id, method, path, status, time }) {
  logEntries.unshift({ id, method, path, status, time });
  renderLog();
}

function updateLogEntry(id, status) {
  const e = logEntries.find(e => e.id === id);
  if (e) { e.status = status; renderLog(); }
}

function renderLog() {
  const list = $('logList');
  list.innerHTML = logEntries.map(e => {
    const statusClass = e.status === null ? 'pending' : (e.status >= 200 && e.status < 300 ? 'ok' : 'err');
    const statusText = e.status === null ? '···' : e.status;
    const methodColor = e.method === 'GET' ? 'color:var(--blue)' : 'color:var(--green)';
    const timeStr = e.time.toLocaleTimeString();
    return `<div class="log-entry">
      <div class="log-entry-top">
        <span class="log-method" style="${methodColor}">${e.method}</span>
        <span class="log-path">${e.path}</span>
        <span class="log-status ${statusClass}">${statusText}</span>
      </div>
      <div class="log-time">${timeStr}</div>
    </div>`;
  }).join('');
}

function clearLog() {
  logEntries = [];
  renderLog();
}

// Init
updateTokenUI();
</script>
</body>
</html>
